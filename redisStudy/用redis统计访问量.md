# 如何用redis统计访问量

[TOC]

## 1.统计每个网页的pv

> 实现方案给每个网页一个独立的 Redis 计数器就可以了，这个计数器的 key 后缀加上当天的日期。这样来一个请求，incrby 一次，最终就可以统计出所有的 PV 数据。

## 2. 统计每个网页的uv

但是 UV 不一样，它要去重，同一个用户一天之内的多次访问请求只能计数一次。这就要求每一个网页请求都需要带上用户的 ID，无论是登陆用户还是未登陆用户都需要一个唯一 ID 来标识。

> 方案一： 使用redis的set集合，当请求过来我们只要sadd将用户id塞进去就可以了， 通过scard可以取出这个集合大小，这个数字就是这个页面的uv数据。缺点就是如果你的页面访问量非常大，比如一个爆款页面几千万的 UV，你需要一个很大的 set 集合来统计，这就非常浪费空间。如果这样的页面很多，那所需要的存储空间是惊人的

![image-20191021004033717](https://tva1.sinaimg.cn/large/006y8mN6ly1g855ltud3bj30y20e0jtq.jpg)



> 方案二：使用hash ,当一个用户访问的时候，如果用户登陆过，那么我们就使用用户的id，如果用户没有登陆过，那么我们也能够前端页面随机生成一个key用来标识用户，当用户访问的时候，我们可以使用**HSET**命令，key可以选择URI与对应的日期进行拼凑，field可以使用用户的id或者随机标识，value可以简单设置为1。优点：简单，容易实现，查询也是非常方便，数据准确性非常高，缺点：占用内存过大。随着key的增多，性能也会下降。小网站还行，拼多多这种数亿PV的网站肯定受不了

![image-20191021004408152](https://tva1.sinaimg.cn/large/006y8mN6ly1g855ly6h5aj30q5082q67.jpg)



> 方案三：使用bitSet  对于一个32位的int，如果我们只用来记录id，那么只能够记录一个用户，但如果我们转成2进制，每位用来表示一个用户，那么我们就能够一口气表示32个用户，空间节省了32倍！对于有大量数据的场景，如果我们使用bitset，那么，可以节省非常多的内存。对于没有登陆的用户，我们也可以使用哈希算法，把对应的用户标识哈希成一个数字id。bitset非常的节省内存，假设有1亿个用户，也只需要100000000/8/1024/1024约等于12兆内存。 Redis已经为我们提供了**SETBIT**的方法，使用起来非常的方便，我们可以看看下面的例子，我们在item页面可以不停地使用**SETBIT**命令，设置用户已经访问了该页面，也可以使用**GETBIT**的方法查询某个用户是否访问。最后我们通过**BITCOUNT**可以统计该网页每天的访问数量。

![image-20191021004913256](https://tva1.sinaimg.cn/large/006y8mN6ly1g855m1wff7j30v00bo0uv.jpg)



> 方案四：使用概率算法 HyperLogLog 对于拼多多这种多个页面都可能非常多访问量的网站，如果所需要的数量不用那么准确，可以使用概率算法，事实上，我们对一个网站的UV的统计，1亿跟1亿零30万其实是差不多的。在Redis中，已经封装了HyperLogLog算法，他是一种基数评估算法。这种算法的特征，一般都是数据不存具体的值，而是存用来计算概率的一些相关数据。 当用户访问网站的时候，我们可以使用**PFADD**命令，设置对应的命令，最后我们只要通过**PFCOUNT**就能顺利计算出最终的结果，因为这个只是一个概率算法，所以可能存在0.81%的误差。
>
> **优点：**占用内存极小，对于一个key，只需要12kb。对于拼多多这种超多用户的特别适用。
>
> **缺点：**查询指定用户的时候，可能会出错，毕竟存的不是具体的数据。总数也存在一定的误差。

![image-20191021005106269](https://tva1.sinaimg.cn/large/006y8mN6ly1g855m559tmj30rq04z0um.jpg)

